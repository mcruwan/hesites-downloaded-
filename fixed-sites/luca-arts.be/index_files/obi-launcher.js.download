var OBI;(()=>{"use strict";var e={d:(t,i)=>{for(var n in i)e.o(i,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:i[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};(()=>{var i,n;e.r(t),e.d(t,{OBI_CHAT_ELEMENT_ID:()=>S,chat:()=>T}),function(e){e.NL="NL",e.EN="EN",e.DE="DE",e.FR="FR"}(i||(i={})),function(e){e.hide="hide",e.emailForm="emailForm"}(n||(n={}));class a{constructor(e=null){Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"url",{enumerable:!0,configurable:!0,writable:!0,value:null})}}const r=["image/jpg","image/jpeg","image/png","image/bmp","image/tiff","image/gif","application/pdf"],o=async e=>{const t=`https://cloudstatic.obi4wan.com/api/v1.0/chat/availability/${e}`,i=await fetch(t);return await i.json()};class s{constructor(e,t){Object.defineProperty(this,"enabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"delaySeconds",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cooldownTime",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"triggerOnlyOnce",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.enabled=t?.enabled??e.enabled,this.delaySeconds=t?.delaySeconds??e.delaySeconds??0,this.text=t?.text||e.text||"",this.cooldownTime=t?.cooldownTime??e.cooldownTime??0,this.triggerOnlyOnce=t?.triggerOnlyOnce??e.triggerOnlyOnce,this.delaySeconds<0&&(this.delaySeconds=0),this.cooldownTime<0&&(this.cooldownTime=0)}}class l{constructor(e,t){Object.defineProperty(this,"widgetText",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"title",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"subtitle",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"welcomeLine",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"color",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logoUri",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"language",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"widgetPosition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"textColor",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.widgetText=t?.widgetText||e.widgetText,this.title=t?.title||e.title,this.subtitle=t?.subtitle||e.subtitle,this.welcomeLine=t?.welcomeLine||e.welcomeLine,this.color=t?.color||e.color,this.logoUri=t?.logoUri||e.logoUri,this.language=t?.language||e.language,this.widgetPosition=t?.widgetPosition||e.widgetPosition,this.textColor=t?.textColor||e.textColor}}class c{constructor(e,t,i,n){Object.defineProperty(this,"guid",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"version",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"preChatFormFields",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"preChatFormText",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"emailFormFields",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"emailFormText",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"unavailableHeader",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"unavailableText",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"noAgentsAvailableText",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"saveChatHistory",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"widgetDisplay",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"enableLauncher",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"headless",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"domainAddress",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"widgetStyle",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoTrigger",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"canSendAttachment",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"overridingStylesURI",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onNewMessage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onTyping",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onChatInit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onConnectionStateChange",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onPreFormSubmitted",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onWidgetClose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onWidgetOpen",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.guid=i.guid,this.version=e,this.preChatFormFields=this._selectFormFields(n?.preChatFormFields,i.preChatFormFields),this.preChatFormText=n?.preChatFormText||i.preChatFormText||"",this.emailFormFields=this._selectFormFields(n?.emailFormFields,i.emailFormFields),this.emailFormText=n?.emailFormText||i.emailFormText||"",this.unavailableHeader=n?.unavailableHeader||i.unavailableHeader||"",this.unavailableText=n?.unavailableText||i.unavailableText,this.noAgentsAvailableText=n?.noAgentsAvailableText||i.noAgentsAvailableText||"",this.saveChatHistory=n?.saveChatHistory??i.saveChatHistory,this.widgetDisplay=n?.widgetDisplay||i.widgetDisplay,this.enableLauncher=n?.enableLauncher??!0,this.headless=n?.headless??!1,this.domainAddress=t,this.widgetStyle=new l(i.widgetStyle,n?.widgetStyle),this.autoTrigger=new s(i.autoTrigger,n?.autoTrigger),this.canSendAttachment=i.canSendAttachment??n?.canSendAttachment,this.overridingStylesURI=n?.overridingStylesURI,this.onNewMessage=n?.onNewMessage,this.onTyping=n?.onTyping,this.onChatInit=n?.onChatInit,this.onConnectionStateChange=n?.onConnectionStateChange,this.onPreFormSubmitted=n?.onPreFormSubmitted,this.onWidgetClose=n?.onWidgetClose,this.onWidgetOpen=n?.onWidgetOpen}_selectFormFields(e,t){return e?.length?e:t?.length?t:[]}}var d;let h;!function(e){e.BottomRight="BottomRight",e.BottomLeft="BottomLeft"}(d||(d={}));const b="Chat widget",g=(e,t,i,n)=>{e?(m(t,"obiChatLauncherOpen"),u(t,"obiChatLauncherHidden"),t.removeAttribute("style")):(u(t,"obiChatLauncherOpen"),t.style.cssText=h,i&&!n||m(t,"obiChatLauncherHidden"))},u=(e,t)=>{e.classList.remove(t)},m=(e,t)=>{e.classList.add(t)};var f,v,p,y;!function(e){e.PageChangeEvent="client-page-change",e.OpenChatMessage="visitor re-opened widget",e.CloseChatMessage="visitor closed widget"}(f||(f={})),function(e){e.OnPreFormSubmitted="client-on-preform-submitted",e.PusherSubscribed="client-pusher-subscribed",e.PusherConnectionStateChange="client-pusher-connection-state-change",e.TypingEvent="client-typing",e.MessageEvent="client-message",e.ShowWidgetEvent="client-show-widget",e.GetConfigEvent="client-get-config",e.SetIframeAttributesEvent="client-set-iframe-attributes"}(v||(v={})),function(e){e.OnSendAttachment="client-on-send-attachment",e.PageChange="client-page-change",e.TypingEvent="client-typing",e.OpenChatEvent="client-open-chat",e.ContextMessageEvent="client-context-message",e.MessageEvent="client-message",e.ConfigEvent="client-config",e.LanguageUpdateEvent="client-language-update"}(p||(p={})),function(e){e.SubscriptionSucceededEvent="pusher:subscription_succeeded",e.MessageEvent="client-message",e.TypingEvent="client-typing",e.EmailFormEvent="client-emailform",e.OpenChatEvent="client-open-chat",e.CloseChatEvent="client-close-chat",e.ContextMessageEvent="client-context-message",e.PageHistoryEvent="client-page-history",e.MessageAcknowledgedEvent="client-message-acknowledged",e.LastMessageReceived="client-last-message-received"}(y||(y={}));const w=(e,t,i)=>{const n=i.data;switch(n.type){case v.GetConfigEvent:O(e,t);break;case y.OpenChatEvent:t.onWidgetOpen&&t.onWidgetOpen(),g(!0,e,t.enableLauncher,t.headless);break;case y.CloseChatEvent:t.onWidgetClose&&t.onWidgetClose(),g(!1,e,t.enableLauncher,t.headless);break;case v.MessageEvent:t.onNewMessage&&t.onNewMessage(JSON.parse(n.message));break;case v.TypingEvent:t.onTyping&&t.onTyping(n.isTyping);break;case v.ShowWidgetEvent:t&&t.enableLauncher&&!t.headless&&u(e,"obiChatLauncherHidden");break;case v.PusherSubscribed:t.onChatInit&&t.onChatInit();break;case v.PusherConnectionStateChange:t.onConnectionStateChange&&t.onConnectionStateChange(n.isConnected);break;case f.PageChangeEvent:C(e,globalThis.location.href);break;case v.OnPreFormSubmitted:t.onPreFormSubmitted&&t.onPreFormSubmitted();break;case v.SetIframeAttributesEvent:((e,t,i)=>{e.title=t,e.lang=i.toLowerCase()})(e,n.title,n.language)}},C=(e,t)=>{const i={type:p.PageChange,url:t};_(e,i)},O=(e,t)=>{const i={type:p.ConfigEvent,config:t};P(e,i)},_=(e,t)=>{e.contentWindow?.postMessage(t,"*")},P=(e,t)=>{e.contentWindow?.postMessage(JSON.parse(JSON.stringify(t)),"*")};class E{constructor(e){Object.defineProperty(this,"open",{enumerable:!0,configurable:!0,writable:!0,value:this._openChat.bind(this)}),Object.defineProperty(this,"isAvailable",{enumerable:!0,configurable:!0,writable:!0,value:this._isAgentAvailable.bind(this)}),Object.defineProperty(this,"sendContextMessage",{enumerable:!0,configurable:!0,writable:!0,value:this._onSendContextMessage.bind(this)}),Object.defineProperty(this,"sendUserMessage",{enumerable:!0,configurable:!0,writable:!0,value:this._onSendUserMessage.bind(this)}),Object.defineProperty(this,"setLanguage",{enumerable:!0,configurable:!0,writable:!0,value:this._onSetLanguage.bind(this)}),Object.defineProperty(this,"setIsTyping",{enumerable:!0,configurable:!0,writable:!0,value:this._onSetIsTyping.bind(this)}),Object.defineProperty(this,"canSendAttachment",{enumerable:!0,configurable:!0,writable:!0,value:this._getCanSendAttachment.bind(this)}),Object.defineProperty(this,"sendAttachment",{enumerable:!0,configurable:!0,writable:!0,value:this._sendAttachmentHandler.bind(this)}),Object.defineProperty(this,"_iframe",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_mergedConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_guid",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_initComplete",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this._initComplete=new Promise(t=>{this.init(e).then(t).catch(console.error)})}async init(e){await this._prepareChat(e)}async _prepareChat(e){if(this._guid=document.getElementById(S)?.dataset?.guid,!this._guid)throw new Error("no guid");this._mergedConfig=await(async(e,t)=>{const i=await fetch(`https://cloudstatic.obi4wan.com/api/v1.1/chat/configuration/${e}`);if(!i.ok)throw new Error(`Configuration from ${i.url} is not available`);const n=await i.json();return new c("1.0.0",globalThis.location.href,n,t)})(this._guid,e);const t=await o(this._guid);(t?.available||this._mergedConfig.widgetDisplay!==n.hide||this._mergedConfig.headless)&&this._initChat()}_initChat(){!this._iframe&&this._mergedConfig&&(this._iframe=(e=>{const t=document.createElement("iframe");var i,n;document.body.append(t),t.title=b,t.id="obi-chat-widget",m(t,"obiChatLauncher"),m(t,"obiChatLauncherHidden"),e.widgetStyle?.widgetText&&(m(t,"obiChatLauncher__text"),i=e.widgetStyle.widgetText,h=`width: ${7*i.length+120}px; max-width: 90%;`,t.style.cssText=h);{const i=`\n        <!DOCTYPE html>\n        <html>\n            <head>\n                <link rel="stylesheet" href=https://cloudstatic.obi4wan.com/chat/obi-chat.bundle.2.0.0.css />\n                ${(n=e.overridingStylesURI)?`<link rel="stylesheet" href=${n} />`:""}\n            </head>\n            <body>\n                <app-root class="app"></app-root>\n                <script src=https://cloudstatic.obi4wan.com/chat/obi-chat.bundle.2.0.0.js><\/script>\n            </body>\n        </html>\n    `;t.setAttribute("src","about:blank"),t.contentWindow&&(t.contentWindow.document.open("text/html","replace"),t.contentWindow.document.write(i),t.contentWindow.document.title=b,t.contentWindow.document.close())}return t})(this._mergedConfig),window.addEventListener("message",w.bind(null,this._iframe,this._mergedConfig)),((e,t=d.BottomRight)=>{switch(t){case d.BottomLeft:m(e,"obiChatLauncherBottomLeft");break;case d.BottomRight:m(e,"obiChatLauncherBottomRight")}})(this._iframe,this._mergedConfig.widgetStyle.widgetPosition),g(!1,this._iframe,this._mergedConfig.enableLauncher,this._mergedConfig.headless),this._listenToUrlChanges(this._iframe))}_openChat(){this._initChat(),this._iframe&&this._mergedConfig&&(g(!0,this._iframe,this._mergedConfig.enableLauncher,this._mergedConfig.headless),(e=>{const t={type:p.OpenChatEvent};_(e,t)})(this._iframe))}_onSendContextMessage(e){this._iframe&&((e,t)=>{const i={type:p.ContextMessageEvent,contextMessage:t};_(e,i)})(this._iframe,e)}_onSendUserMessage(e){this._iframe&&((e,t)=>{const i={type:p.MessageEvent,userMessage:t};_(e,i)})(this._iframe,{...e,author:e.author??new a,displayInWidget:!0,url:globalThis.location.href})}_onSetLanguage(e){switch(e){case i.DE:case i.EN:case i.FR:case i.NL:this._iframe&&((e,t)=>{const i={type:p.LanguageUpdateEvent,language:t};_(e,i)})(this._iframe,e);break;default:console.error('Unknown language. Please select "DE", "EN", "FR" or "NL"')}}_onSetIsTyping(e){this._iframe&&((e,t)=>{const i={type:p.TypingEvent,isTyping:t};_(e,i)})(this._iframe,e)}async _isAgentAvailable(){return!!this._guid&&o(this._guid)}async _getCanSendAttachment(){return this._initComplete.then(()=>!!this._mergedConfig?.canSendAttachment)}_sendAttachmentHandler(e){const t=e.target;if(t.files){const e=t.files[0];(e=>r.includes(e.type))(e)&&this._iframe&&((e,t)=>{const i={type:p.OnSendAttachment,file:t};_(e,i)})(this._iframe,e)}}_listenToUrlChanges(e){const t=history.pushState.bind(history);globalThis.history.pushState=function(...i){t.apply(history,i),C(e,globalThis.location.href)}}}const S="obi-chat-launcher";function T(e){if("true"!==j().dataset.config)throw new Error('Please set data-config="true" property before starting a chat with own config');return new E(e)}function j(){const e=document.getElementById(S);if(!e)throw new Error(`No element found with id '${S}'`);return e}!function(){{const e=document.createElement("link");e.type="text/css",e.rel="stylesheet",e.href="https://cloudstatic.obi4wan.com/chat/obi-launcher.css",document.getElementsByTagName("head")[0].append(e)}}(),"true"!==j().dataset.config&&new E})(),OBI=t})();
