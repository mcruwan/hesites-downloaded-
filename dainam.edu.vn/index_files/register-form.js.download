// admission form
const registerForm = document.querySelector(".register-form form");
const registerSubmitBtn = registerForm?.querySelector("button[type=submit]");
const inputs = registerForm?.querySelectorAll("input:not([type=hidden])");

let isSubmitted = false;
inputs?.forEach((input) => {
  input.addEventListener("input", function () {
    if (!isSubmitted) return;
    validInputClass(this);
    registerSubmitBtn.disabled = !registerForm.checkValidity();
  });
});
registerForm?.addEventListener("submit", async function (e) {
  isSubmitted = true;
  e.preventDefault();
  inputs.forEach(validInputClass);

  if (!this.checkValidity()) {
    registerSubmitBtn.disabled = true;
    return;
  }
  isSubmitted = false;

  const formData = new FormData(this);
  const formValuteIds = [
    "admission-hvt",
    "admission-sdt",
    "admission-ngaysinh",
    "admission-email",
    "admission-dc",
    "admission-hdt",
    "admission-nhqt",
  ];
  const [
    admissionHvt,
    admissionSdt,
    admissionNgaysinh,
    admissionEmail,
    admissionDc,
    admissionHdt,
    admissionNhqt,
  ] = formValuteIds.map((id) => formData.get(id));

  const requestData = {
    fullname: admissionHvt,
    phone: admissionSdt,
    birthday: admissionNgaysinh,
    email: admissionEmail,
    address: admissionDc,
    enrollment_program_id: admissionHdt,
    major: admissionNhqt,
  };

  try {
    const response = await fetch("/api/student-consultation", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(requestData),
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || "Có lỗi xảy ra khi gửi form.");
    }

    const result = await response.json();

    // Mở modal thành công
    const successModal = new bootstrap.Modal(document.getElementById("successModal"));
    successModal.show();

    this.reset();
  } catch (error) {
    const errorModal = new bootstrap.Modal(document.getElementById("registerErrorModal"));
    errorModal.show();
  }
});


function validInputClass(input) {
  const isValid = input.value.trim() && input.checkValidity();
  input.classList.toggle("is-invalid", !isValid);
  input.classList.toggle("is-valid", isValid);
}

// selectionion input
const registerFormListDropdowItem = registerForm?.querySelectorAll(".dropdown-item");

registerFormListDropdowItem?.forEach((liItem) => {
  liItem.addEventListener("click", selectItem);
  if (liItem.matches(":first-child")) {
    liItem.click();
  }
});

function selectItem() {
  const {
    previousElementSibling: buttonDropdown,
    nextElementSibling: selectInput,
  } = this.parentElement;

  if (buttonDropdown) {
    buttonDropdown.textContent = this.textContent;
  }
  const dataValue = this.dataset.value;
  if (selectInput) {
    selectInput.value = dataValue;
  }
  registerFormListDropdowItem.forEach((li) => {
    if (li.dataset.value === dataValue) {
      li.setAttribute("selected", true);
    } else {
      li.removeAttribute("selected");
    }
  });
}
